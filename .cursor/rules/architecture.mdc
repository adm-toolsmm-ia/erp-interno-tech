---
alwaysApply: true
description: "Arquitetura MVP, multi-tenancy e padrÃµes fundamentais"
globs: *.ts,*.tsx,*.js,*.jsx
---

# ğŸ—ï¸ ERP Architecture MVP

## Multi-Tenancy ObrigatÃ³ria

### Filtros AutomÃ¡ticos
```typescript
// SEMPRE filtrar por empresaId
const projetos = await prisma.projeto.findMany({
  where: {
    empresaId: req.empresaId, // OBRIGATÃ“RIO
    deletedAt: null, // OBRIGATÃ“RIO
    // outros filtros...
  }
});
```

### ValidaÃ§Ã£o de Tenant
```typescript
// SEMPRE validar tenant em APIs
export async function GET(request: Request) {
  const empresaId = request.headers.get('x-empresa-id');
  
  if (!empresaId) {
    return Response.json({ error: 'empresaId required' }, { status: 400 });
  }
  
  // Continuar com lÃ³gica...
}
```

## Soft Delete Universal

### Modelo Base
```typescript
// SEMPRE incluir em todos os modelos
interface BaseModel {
  id: string;
  empresaId: string;
  createdAt: Date;
  updatedAt: Date;
  deletedAt?: Date; // OBRIGATÃ“RIO
  deletedById?: string;
}
```

### Queries com Soft Delete
```typescript
// SEMPRE filtrar deletedAt
const clientes = await prisma.cliente.findMany({
  where: {
    empresaId: req.empresaId,
    deletedAt: null // OBRIGATÃ“RIO
  }
});
```

## Estrutura de Resposta API

### PadrÃ£o ObrigatÃ³rio
```typescript
interface ApiResponse<T> {
  data: T;
  meta: {
    tenantId: string;
    requestId: string;
    timestamp: string;
    version: string;
  };
}

// SEMPRE usar este formato
export async function GET(request: Request) {
  const data = await getData();
  
  return Response.json({
    data,
    meta: {
      tenantId: req.empresaId,
      requestId: crypto.randomUUID(),
      timestamp: new Date().toISOString(),
      version: "1.0.0"
    }
  });
}
```

## Endpoints Next.js API Routes

### Estrutura PadrÃ£o
```typescript
// app/api/[resource]/route.ts
export async function GET(request: Request) {
  // 1. Validar tenant
  // 2. Filtrar por empresaId
  // 3. Aplicar soft delete
  // 4. Retornar resposta padronizada
}

export async function POST(request: Request) {
  // 1. Validar entrada
  // 2. Incluir empresaId
  // 3. Salvar com soft delete
  // 4. Retornar resposta padronizada
}
```

## Observabilidade MÃ­nima

### Health Check
```typescript
// app/api/health/route.ts
export async function GET() {
  return Response.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
}
```

### Logs Estruturados
```typescript
// SEMPRE usar logs estruturados
console.log(JSON.stringify({
  level: 'info',
  event: 'projeto_created',
  empresaId: req.empresaId,
  projetoId: projeto.id,
  timestamp: new Date().toISOString()
}));
```

## Testes ObrigatÃ³rios

### Estrutura de Teste
```typescript
describe('ProjetoService', () => {
  it('should filter by empresaId', async () => {
    const projetos = await projetoService.findAll('empresa-1');
    expect(projetos.every(p => p.empresaId === 'empresa-1')).toBe(true);
  });
  
  it('should apply soft delete', async () => {
    await projetoService.delete('projeto-1');
    const projeto = await projetoService.findById('projeto-1');
    expect(projeto.deletedAt).toBeDefined();
  });
});
```

## Estrutura de Pastas

### OrganizaÃ§Ã£o ObrigatÃ³ria
```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ health/
â”‚   â”‚   â”œâ”€â”€ empresas/
â”‚   â”‚   â”œâ”€â”€ clientes/
â”‚   â”‚   â”œâ”€â”€ projetos/
â”‚   â”‚   â””â”€â”€ documentos/
â”‚   â””â”€â”€ (dashboard)/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ forms/
â”‚   â”œâ”€â”€ tables/
â”‚   â””â”€â”€ modals/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ prisma.ts
â”‚   â”œâ”€â”€ supabase.ts
â”‚   â””â”€â”€ utils.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-tenant.ts
â”‚   â””â”€â”€ use-crud.ts
â””â”€â”€ types/
    â”œâ”€â”€ api.ts
    â””â”€â”€ database.ts
```

## Checklist de Arquitetura

### Multi-Tenancy
- [ ] **empresaId** em todas as operaÃ§Ãµes
- [ ] **Filtros** automÃ¡ticos por tenant
- [ ] **ValidaÃ§Ã£o** de tenant em APIs
- [ ] **Isolamento** de dados garantido

### Soft Delete
- [ ] **deletedAt** em todos os modelos
- [ ] **Filtros** deletedAt: null
- [ ] **Auditoria** de exclusÃµes
- [ ] **Rollback** possÃ­vel

### APIs
- [ ] **Resposta** padronizada
- [ ] **Meta** com tenantId
- [ ] **ValidaÃ§Ã£o** de entrada
- [ ] **Logs** estruturados

### Testes
- [ ] **Multi-tenancy** testado
- [ ] **Soft delete** testado
- [ ] **ValidaÃ§Ãµes** testadas
- [ ] **APIs** testadas